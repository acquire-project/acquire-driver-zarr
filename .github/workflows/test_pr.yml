name: Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  BUILD_TYPE: Release

jobs:
  test:
    name: ${{ matrix.platform }}
    runs-on: ${{ matrix.platform }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        platform:
          - "ubuntu-latest"
          - "windows-latest"
          - "macos-latest"
        include:
          - platform: "ubuntu-latest"
            vcpkg_triplet: "x64-linux"
          - platform: "windows-latest"
            vcpkg_triplet: "x64-windows-static"
          - platform: "macos-latest"
            vcpkg_triplet: "arm64-osx"
    permissions:
      actions: write
    env:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: password
      MINIO_URL: http://localhost:9000
      MINIO_ALIAS: myminio
      MINIO_BUCKET: acquire-test
      MINIO_ACCESS_KEY: acquire
      MINIO_SECRET_KEY: 12345678

    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.10.0
        with:
          access_token: ${{ github.token }}

      - uses: actions/checkout@v3
        with:
          submodules: true
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg && ./bootstrap-vcpkg.sh
          echo "VCPKG_ROOT=${{github.workspace}}/vcpkg" >> $GITHUB_ENV
          echo "${{github.workspace}}/vcpkg" >> $GITHUB_PATH
          ./vcpkg integrate install
        shell: bash

      - name: Install and start minio
        if: runner.os == 'Linux'
        run: |
          apt update && apt install -y tmux wget
          wget https://dl.min.io/server/minio/release/linux-amd64/minio -O /usr/local/bin/minio
          wget https://dl.min.io/client/mc/release/linux-amd64/mc -O /usr/local/bin/mcli
          chmod +x /usr/local/bin/minio
          chmod +x /usr/local/bin/mcli
          tmux new -d -s minio
          tmux send-keys -t minio "MINIO_ROOT_USER=$MINIO_ROOT_USER MINIO_ROOT_PASSWORD=$MINIO_ROOT_PASSWORD minio server /tmp/minio --console-address :9001" Enter
          sleep 5
          mcli alias set $MINIO_ALIAS $MINIO_URL $MINIO_ROOT_USER $MINIO_ROOT_PASSWORD
          mcli admin user svcacct add --access-key $MINIO_ACCESS_KEY --secret-key $MINIO_SECRET_KEY $MINIO_ALIAS $MINIO_ROOT_USER
          mcli mb $MINIO_ALIAS/$MINIO_BUCKET
          echo "ZARR_S3_ENDPOINT=$MINIO_URL" >> $GITHUB_ENV
          echo "ZARR_S3_BUCKET_NAME=$MINIO_BUCKET" >> $GITHUB_ENV
          echo "ZARR_S3_ACCESS_KEY_ID=$MINIO_ACCESS_KEY" >> $GITHUB_ENV
          echo "ZARR_S3_SECRET_ACCESS_KEY=$MINIO_SECRET_KEY" >> $GITHUB_ENV

      - name: Configure CMake
        run: |
          cmake --preset=default -DVCPKG_TARGET_TRIPLET=${{matrix.vcpkg_triplet}}
          cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

      - name: Build
        run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}

      - name: Test
        working-directory: ${{github.workspace}}/build
        run: ctest -C ${{env.BUILD_TYPE}} -L acquire-zarr --output-on-failure
